<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gecko Adhesion Simulator — Simulation</title>
<style>
  :root{
    --bg:#031018; --panel:#0e161b; --muted:#98a3ad; --accent:#ffbd59;
    --good:#38c172; --warn:#f6c85f; --bad:#ff6b6b; --glass: rgba(255,255,255,0.02);
    font-family:Inter,system-ui,Segoe UI,Roboto,Arial; -webkit-font-smoothing:antialiased;
  }

  html,body{height:100%; margin:0; background:
    radial-gradient(1200px 400px at 10% 10%, rgba(255,189,89,0.03), transparent 6%),
    linear-gradient(180deg,#021018 0%, #031018 100%); color:#d7e1e8;}

  /* outer container */
  .page { max-width:1400px; margin:18px auto; padding:12px; box-sizing:border-box; }

  header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px;}
  header h1{ margin:0; font-size:20px; color:#fff; font-weight:600; }
  header p{ margin:0; color:var(--muted); font-size:13px; }

  /* layout */
  .wrap{ display:flex; gap:28px; align-items:flex-start; }
  .controls-panel{
    width:360px; min-width:300px; max-width:420px;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:14px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,0.6);
    box-sizing:border-box; overflow:auto; max-height:calc(100vh - 60px);
  }
  .viz-panel { flex:1; min-height:640px; background:linear-gradient(180deg,#061018,#041018); border-radius:14px; position:relative; box-shadow:0 10px 40px rgba(0,0,0,0.6); padding:12px; display:flex; flex-direction:column; }

  /* small header inside panel */
  .panel-header { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:10px; }
  .panel-header h2{ margin:0; font-size:16px; }
  .muted{ color:var(--muted); font-size:13px; }

  /* control elements */
  label{ color:var(--muted); font-size:13px; display:block; margin-bottom:6px; }
  .row{ display:flex; gap:8px; align-items:center; margin:10px 0; }
  .inline{ display:inline-flex; gap:8px; align-items:center; }
  .small-input{ width:100%; padding:9px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:inherit; font-size:13px; box-sizing:border-box; }
  input[type=range]{ width:100%; }
  .btns{ display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
  button{ background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted); padding:8px 12px; border-radius:8px; cursor:pointer; font-size:13px; }
  button.primary{ background:linear-gradient(90deg,var(--accent), #ff9e2e); color:#071018; border:none; box-shadow:0 6px 18px rgba(255,189,89,0.08); }
  .readout{ margin-top:12px; padding:12px; border-radius:10px; background:var(--glass); font-family:monospace; font-size:13px; line-height:1.5; }
  .legend{ margin-top:10px; display:flex; gap:10px; align-items:center; color:var(--muted); font-size:13px; }

  /* viz */
  #canvas2d{ width:100%; height:100%; display:block; border-radius:8px; background:linear-gradient(180deg,#071018,#031018); }
  .status-badge{ position:absolute; right:18px; top:18px; padding:8px 12px; background:rgba(0,0,0,0.45); border-radius:8px; color:#fff; font-weight:700; z-index:40; }
  .collapse-btn{ background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); padding:6px 8px; border-radius:8px; cursor:pointer; font-size:13px; }

  /* small responsive */
  @media (max-width:980px){
    .wrap{ flex-direction:column; gap:14px; }
    .controls-panel{ width:100%; max-height:none; }
    .viz-panel{ min-height:520px; }
  }
</style>
</head>
<body>
<div class="page">
  <header>
    <div>
      <h1>Gecko Adhesion — Load Simulator</h1>
      <p class="muted">Interactive simulator: mass, gravity, area, stress & efficiency. Toggle the stress overlay; collapse controls to focus on the visualization.</p>
    </div>
    <div style="display:flex; gap:8px; align-items:center;">
      <button id="collapseControls" class="collapse-btn">Collapse Controls</button>
      <div style="font-size:13px; color:var(--muted)">Accent: <strong style="color:var(--accent); margin-left:6px">#ffbd59</strong></div>
    </div>
  </header>

  <div class="wrap">
    <!-- CONTROLS -->
    <aside class="controls-panel" id="controlsPanel" aria-label="Simulation Controls">
      <div class="panel-header">
        <h2>Controls</h2>
        <div class="muted" id="modeLabel">Mode: Semi-Advanced</div>
      </div>

      <label>Weight presets</label>
      <div class="btns" id="presets">
        <button data-mass="0.18">Phone — 0.18 kg</button>
        <button data-mass="2.0">Laptop — 2 kg</button>
        <button data-mass="8.0">Backpack — 8 kg</button>
        <button class="primary" data-mass="70">Person — 70 kg</button>
      </div>

      <div class="row" style="margin-top:12px;">
        <label style="width:122px;">Manual mass (kg)</label>
        <input id="massInput" class="small-input" type="number" step="0.01" min="0" value="2.00" />
      </div>

      <div class="row">
        <label style="width:122px;">Gravity preset</label>
        <select id="gravityPreset" class="small-input">
          <option value="9.81">Earth — 9.81 m/s²</option>
          <option value="1.62">Moon — 1.62 m/s²</option>
          <option value="3.71">Mars — 3.71 m/s²</option>
          <option value="24.79">Jupiter — 24.79 m/s²</option>
          <option value="0.0001">ISS — 1e-4 m/s² (microgravity)</option>
          <option value="custom">Custom...</option>
        </select>
      </div>

      <div class="row" id="customGravityRow" style="display:none">
        <label style="width:122px;">Custom g (m/s²)</label>
        <input id="gravityInput" class="small-input" type="number" step="0.001" min="0" value="9.81" />
      </div>

      <div style="height:8px"></div>

      <label>Contact area</label>
      <div class="row">
        <input id="areaRange" type="range" min="1" max="200" value="10" />
        <div style="width:84px; text-align:right;" id="areaLabel">10 cm²</div>
      </div>

      <label>Adhesive stress σ (kPa)</label>
      <div class="row">
        <input id="sigmaRange" type="range" min="50" max="1000" value="120" />
        <div style="width:84px; text-align:right;" id="sigmaLabel">120 kPa</div>
      </div>

      <label>Surface efficiency η</label>
      <div class="row">
        <input id="etaRange" type="range" min="0.4" max="1.0" step="0.01" value="0.9" />
        <div style="width:84px; text-align:right;" id="etaLabel">0.90</div>
      </div>

      <div style="height:6px"></div>

      <div style="display:flex; gap:10px; align-items:center; margin-top:8px;">
        <button id="view2d" class="primary">2D View</button>
        <button id="view3d" class="">3D View</button>
        <label style="margin-left:8px;" class="inline"><input id="stressToggle" type="checkbox" checked /> <span class="muted">Stress overlay</span></label>
      </div>

      <div class="readout" id="results" aria-live="polite">
        <div>Adhesive Force: <strong id="Fadh">—</strong> N</div>
        <div>Weight Force: <strong id="Fg">—</strong> N</div>
        <div>Safety Factor (SF): <strong id="SF">—</strong></div>
        <div>Status: <strong id="status" style="color:var(--muted)">—</strong></div>
      </div>

      <div class="legend">
        <div style="display:flex; gap:8px; align-items:center">
          <div style="width:12px;height:12px;background:var(--good);border-radius:3px"></div><div class="muted">Hold</div>
        </div>
        <div style="display:flex; gap:8px; align-items:center">
          <div style="width:12px;height:12px;background:var(--warn);border-radius:3px"></div><div class="muted">Warning</div>
        </div>
        <div style="display:flex; gap:8px; align-items:center">
          <div style="width:12px;height:12px;background:var(--bad);border-radius:3px"></div><div class="muted">Fail</div>
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="muted">Tip: collapse controls to focus on the visualization. You can still expand anytime.</div>
      <div style="height:24px"></div>
    </aside>

    <!-- VISUALIZATION -->
    <main class="viz-panel">
      <div class="status-badge" id="statusBadge">Ready</div>

      <canvas id="canvas2d"></canvas>
      <div id="threeContainer" style="display:none; width:100%; height:100%;"></div>
      <!-- stress overlay is managed through canvas drawing -->
    </main>
  </div>
</div>

<!-- NOTE: CITATIONS REMOVED FROM PAGE BY REQUEST. CITATION LINKS PROVIDED BELOW IN CHAT (PRIVATE). -->

<script src="https://cdn.jsdelivr.net/npm/three@0.149.0/build/three.min.js"></script>
<script>
/* ======= Simulation logic and UI glue (unchanged core) ======= */
(() => {
  // DOM
  const controlsPanel = document.getElementById('controlsPanel');
  const collapseControlsBtn = document.getElementById('collapseControls');
  const massInput = document.getElementById('massInput');
  const gravityPreset = document.getElementById('gravityPreset');
  const gravityInput = document.getElementById('gravityInput');
  const customGravityRow = document.getElementById('customGravityRow');
  const areaRange = document.getElementById('areaRange');
  const areaLabel = document.getElementById('areaLabel');
  const sigmaRange = document.getElementById('sigmaRange');
  const sigmaLabel = document.getElementById('sigmaLabel');
  const etaRange = document.getElementById('etaRange');
  const etaLabel = document.getElementById('etaLabel');
  const FadhEl = document.getElementById('Fadh');
  const FgEl = document.getElementById('Fg');
  const SFEl = document.getElementById('SF');
  const statusEl = document.getElementById('status');
  const canvas2d = document.getElementById('canvas2d');
  const stressToggle = document.getElementById('stressToggle');
  const view2dBtn = document.getElementById('view2d');
  const view3dBtn = document.getElementById('view3d');
  const threeContainer = document.getElementById('threeContainer');
  const statusBadge = document.getElementById('statusBadge');
  const presetBtns = document.querySelectorAll('[data-mass]');
  const modeLabel = document.getElementById('modeLabel');

  // initial UI state
  let controlsCollapsed = false;
  collapseControlsBtn.addEventListener('click', ()=>{
    controlsCollapsed = !controlsCollapsed;
    controlsPanel.style.display = controlsCollapsed ? 'none' : 'block';
    collapseControlsBtn.textContent = controlsCollapsed ? 'Show Controls' : 'Collapse Controls';
    // resize canvas to use full width when collapsed
    setTimeout(()=>{ onResize(); }, 60);
  });

  // Defaults (physically grounded)
  let sigma_kPa = Number(sigmaRange.value); // in kPa (UI)
  let sigma = sigma_kPa * 1000; // N/m^2
  let area_cm2 = Number(areaRange.value); // cm^2
  let area_m2 = area_cm2 * 1e-4;
  let eta = Number(etaRange.value); // efficiency
  let mass = Number(massInput.value); // kg
  let g = Number(gravityPreset.value); // m/s^2

  // preset mass buttons
  document.querySelectorAll('[data-mass]').forEach(b=>{
    b.addEventListener('click', ()=> {
      massInput.value = b.dataset.mass;
      mass = Number(massInput.value);
      updateAll();
    });
  });

  massInput.addEventListener('input', ()=> { mass = Number(massInput.value); updateAll(); });

  gravityPreset.addEventListener('change', ()=>{
    if (gravityPreset.value === 'custom') {
      customGravityRow.style.display = 'flex';
      gravityInput.value = '1.62';
      g = Number(gravityInput.value);
    } else {
      customGravityRow.style.display = 'none';
      g = Number(gravityPreset.value);
    }
    updateAll();
  });
  gravityInput.addEventListener('input', ()=> { g = Number(gravityInput.value); updateAll(); });

  areaRange.addEventListener('input', ()=>{
    area_cm2 = Number(areaRange.value); areaLabel.textContent = area_cm2 + ' cm²';
    area_m2 = area_cm2 * 1e-4;
    updateAll();
  });

  sigmaRange.addEventListener('input', ()=>{
    sigma_kPa = Number(sigmaRange.value); sigmaLabel.textContent = sigma_kPa + ' kPa';
    sigma = sigma_kPa * 1000;
    updateAll();
  });

  etaRange.addEventListener('input', ()=>{
    eta = Number(etaRange.value); etaLabel.textContent = eta.toFixed(2);
    updateAll();
  });

  stressToggle.addEventListener('change', ()=> { draw(); });

  view2dBtn.addEventListener('click', ()=>{
    threeContainer.style.display = 'none';
    canvas2d.style.display = 'block';
    view2dBtn.classList.add('primary'); view3dBtn.classList.remove('primary');
    draw();
  });

  view3dBtn.addEventListener('click', ()=> {
    canvas2d.style.display = 'none';
    threeContainer.style.display = 'block';
    view3dBtn.classList.add('primary'); view2dBtn.classList.remove('primary');
    if (!threeState.inited) initThree();
    drawThree();
  });

  // canvas setup 2D
  const ctx = canvas2d.getContext('2d');
  function onResize(){
    // compute available width; if controls collapsed, use full page width
    const parent = canvas2d.parentElement;
    canvas2d.width = canvas2d.clientWidth = parent.clientWidth - 24;
    canvas2d.height = canvas2d.clientHeight = parent.clientHeight - 24;
    draw();
    if (threeState.inited) {
      threeState.renderer.setSize(threeContainer.clientWidth, threeContainer.clientHeight);
      threeState.camera.aspect = threeContainer.clientWidth / threeContainer.clientHeight;
      threeState.camera.updateProjectionMatrix();
    }
  }
  window.addEventListener('resize', onResize);
  // call after layout ready
  setTimeout(onResize, 70);

  // physics
  function computeForces(){
    const Fadh = sigma * area_m2 * eta;
    const Fg = mass * g;
    const SF = (Fg > 0) ? (Fadh / Fg) : Infinity;
    return {Fadh, Fg, SF};
  }

  function updateAll(){
    const {Fadh, Fg, SF} = computeForces();
    FadhEl.textContent = Fadh.toFixed(2);
    FgEl.textContent = Fg.toFixed(2);
    SFEl.textContent = (isFinite(SF) ? SF.toFixed(2) : '—');
    let status = 'HOLD';
    let color = 'var(--good)';
    if (SF < 1) { status = 'FAIL'; color = 'var(--bad)'; } 
    else if (SF < 1.2) { status = 'WARNING'; color = 'var(--warn)'; }
    statusEl.textContent = status; statusEl.style.color = color;
    statusBadge.textContent = status;
    statusBadge.style.background = (status==='HOLD') ? 'rgba(56,193,114,0.12)' : (status==='WARNING' ? 'rgba(246,200,95,0.10)' : 'rgba(255,107,107,0.08)');
    draw();
    if (threeState.inited) updateThreeObjects(Fadh, Fg);
  }

  // 2D draw function (kept same logic, but uses roomier layout)
  function draw(){
    const w = canvas2d.width, h = canvas2d.height;
    ctx.clearRect(0,0,w,h);
    const grad = ctx.createLinearGradient(0,0,0,h);
    grad.addColorStop(0,'#071018'); grad.addColorStop(1,'#031018');
    ctx.fillStyle = grad; ctx.fillRect(0,0,w,h);

    // wall
    const wallX = Math.max(60, w*0.12), wallW = Math.max(44, w*0.06);
    ctx.fillStyle = '#0b1220'; ctx.fillRect(wallX - wallW, h*0.12, wallW, h*0.76);

    // tape patch
    const patchW = Math.min(340, w*0.18);
    const patchH = Math.min(140, h*0.12);
    const patchX = wallX + 12;
    const patchY = h*0.28;

    // compute forces
    const {Fadh, Fg, SF} = computeForces();
    const stressFactor = (sigma*area_m2>0) ? (Fg / (sigma*area_m2)) : 0;
    const stressColor = stressFactor <= 0.8 ? 'rgba(56,193,114,0.18)' : (stressFactor <= 1.0 ? 'rgba(246,200,95,0.24)' : 'rgba(255,107,107,0.28)');

    // draw patch & grid
    ctx.save();
    ctx.translate(patchX, patchY);
    ctx.fillStyle = '#0e1b22'; ctx.fillRect(0,0,patchW,patchH);
    ctx.strokeStyle = 'rgba(255,255,255,0.03)'; ctx.lineWidth = 1;
    for(let x=6;x<patchW;x+=10){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,patchH); ctx.stroke(); }
    for(let y=6;y<patchH;y+=10){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(patchW,y); ctx.stroke(); }
    if (stressToggle.checked){
      ctx.fillStyle = stressColor; ctx.fillRect(0,0,patchW,patchH);
      ctx.fillStyle = 'rgba(255,255,255,0.04)'; ctx.fillRect(-8,patchH+8, patchW+16, 8);
      const barWidth = Math.max(2, Math.min(patchW+16, (stressFactor/1.5)*(patchW+16)));
      ctx.fillStyle = stressFactor<=1 ? 'rgba(255,255,255,0.06)' : 'rgba(255,0,0,0.22)';
      ctx.fillRect(-8,patchH+8, barWidth, 8);
      ctx.fillStyle = 'rgba(255,255,255,0.6)'; ctx.font = '13px monospace';
      ctx.fillText('stress factor: ' + stressFactor.toFixed(2), 6, patchH+30);
    }
    ctx.restore();

    // object block
    const blockW = Math.min(260, w*0.16), blockH = Math.min(160, h*0.14);
    const blockX = patchX + patchW + 28;
    const fail = SF < 1;
    const t = Date.now()/1000;
    const dropOffset = fail ? Math.min(h*0.45, (t % 1.5) * 260) : 0;
    ctx.beginPath(); ctx.strokeStyle = 'rgba(255,255,255,0.06)'; ctx.lineWidth = 2;
    ctx.moveTo(patchX + patchW*0.5, patchY + patchH); ctx.lineTo(blockX + blockW*0.5, patchY + patchH + 26 + dropOffset); ctx.stroke();
    ctx.fillStyle = fail ? '#4b1012' : '#163242'; ctx.fillRect(blockX, patchY + patchH + 26 + dropOffset, blockW, blockH);
    ctx.strokeStyle = 'rgba(255,255,255,0.04)'; ctx.strokeRect(blockX, patchY + patchH + 26 + dropOffset, blockW, blockH);

    // arrows & labels
    ctx.fillStyle = 'rgba(255,255,255,0.9)'; ctx.font = '14px monospace';
    const arrowX = blockX + blockW + 22;
    const arrowY = patchY + patchH + 26 + dropOffset + 10;
    drawArrow(arrowX, arrowY, arrowX, arrowY + 120 * Math.min(2.0, mass/10 + g/9.81), '#ff6b6b');
    ctx.fillText('Weight (Fg): ' + Fg.toFixed(1) + ' N', arrowX + 12, arrowY + 120 * Math.min(2.0, mass/10 + g/9.81) + 18);
    const adhX = patchX + patchW*0.5;
    const adhY = patchY + patchH + 10;
    drawArrow(adhX, adhY + 120, adhX, adhY, '#38c172');
    ctx.fillText('Adhesion (Fadh): ' + Fadh.toFixed(1) + ' N', adhX - 38, adhY - 8);

    // safety factor badge
    ctx.fillStyle = SF < 1 ? '#ff6b6b' : (SF < 1.2 ? '#f6c85f' : '#38c172');
    ctx.fillRect(w - 260, 18, 220, 40);
    ctx.fillStyle = '#071018'; ctx.font='700 15px monospace';
    ctx.fillText('SF: ' + (isFinite(SF) ? SF.toFixed(2) : '--'), w - 190, 44);

    function drawArrow(x1,y1,x2,y2,color){
      const dx = x2-x1, dy = y2-y1;
      ctx.strokeStyle = color; ctx.fillStyle = color; ctx.lineWidth = 3;
      ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
      const h = 9; const ang = Math.atan2(dy,dx);
      ctx.beginPath();
      ctx.moveTo(x2, y2);
      ctx.lineTo(x2 - h*Math.cos(ang - 0.45), y2 - h*Math.sin(ang - 0.45));
      ctx.lineTo(x2 - h*Math.cos(ang + 0.45), y2 - h*Math.sin(ang + 0.45));
      ctx.closePath(); ctx.fill();
    }
  }

  // Three.js minimal 3D (same functionality)
  let threeState = { inited:false, scene:null, camera:null, renderer:null, cube:null, tape:null, anim:false };
  function initThree(){
    const W = threeContainer.clientWidth, H = threeContainer.clientHeight;
    const scene = new THREE.Scene(); scene.background = new THREE.Color(0x041018);
    const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
    renderer.setSize(W,H); threeContainer.appendChild(renderer.domElement);
    const camera = new THREE.PerspectiveCamera(45, W/H, 0.1, 1000); camera.position.set(0,10,28);
    const light = new THREE.DirectionalLight(0xfff7e8, 1.0); light.position.set(40,60,40); scene.add(light);
    scene.add(new THREE.AmbientLight(0xffffff,0.4));
    const wall = new THREE.Mesh(new THREE.PlaneGeometry(30,30), new THREE.MeshStandardMaterial({color:0x09121a, roughness:0.95}));
    wall.rotation.y = Math.PI/2; wall.position.x = -12; scene.add(wall);
    const tape = new THREE.Mesh(new THREE.PlaneGeometry(6,3), new THREE.MeshStandardMaterial({ color:0x072227, roughness:0.6 }));
    tape.position.set(-6.5,5,0.9); tape.rotation.y = -0.05; scene.add(tape);
    const cubeGeo = new THREE.BoxGeometry(4,3,2.5);
    const cubeMat = new THREE.MeshStandardMaterial({ color:0x253241, roughness:0.6 });
    const cube = new THREE.Mesh(cubeGeo, cubeMat); cube.position.set(-1,2.4,0); scene.add(cube);

    threeState = { inited:true, scene, camera, renderer, cube, tape };
    window.addEventListener('resize', ()=> {
      threeState.renderer.setSize(threeContainer.clientWidth, threeContainer.clientHeight);
      threeState.camera.aspect = threeContainer.clientWidth/threeContainer.clientHeight;
      threeState.camera.updateProjectionMatrix();
    });
    animateThree();
  }
  function updateThreeObjects(Fadh, Fg){
    if (!threeState.inited) return;
    const fail = Fadh < Fg;
    threeState.cube.material.color.set(fail ? 0x7b2a2a : 0x253241);
    if (fail) threeState.cube.position.y = Math.max(-8, threeState.cube.position.y - 0.06);
    else threeState.cube.position.y += (2.4 - threeState.cube.position.y) * 0.08;
  }
  function animateThree(){
    if (!threeState.inited) return;
    requestAnimationFrame(animateThree);
    threeState.renderer.render(threeState.scene, threeState.camera);
  }
  function drawThree(){ if (!threeState.inited) initThree(); }

  // initial update & resize
  updateAll();
  setInterval(()=>{ draw(); }, 60);
  function onResize(){ onResizeDebounced(); }
  let onResizeDebounced = debounce(()=>{ onResize(); }, 80);
  function onResize(){ const parent = canvas2d.parentElement; canvas2d.width = canvas2d.clientWidth = parent.clientWidth - 24; canvas2d.height = canvas2d.clientHeight = parent.clientHeight - 24; draw(); if (threeState.inited) { threeState.renderer.setSize(threeContainer.clientWidth, threeContainer.clientHeight); threeState.camera.aspect = threeContainer.clientWidth/threeContainer.clientHeight; threeState.camera.updateProjectionMatrix(); } }
  function debounce(fn, t){ let id; return (...a)=>{ clearTimeout(id); id = setTimeout(()=>fn(...a), t); }; }

  // expose compute
  window.simulator = { computeForces, updateAll };
})();
</script>
</body>
</html>
